/*! WIMP Member Directory - v0.1.0
 * http://beawimp.org/member-directory
 * Copyright (c) 2015;
 * Licensed GPLv2+
 */
var WMD;!function(a,b,c){"use strict";var d,e,f=a.document,g=a.wp,h=(a.tinymce,!1),i=!1;WMD={init:function(){WMD.uploadLogo(),WMD.uploadPortfolio(),WMD.deletePortfolio(),WMD.changePortfolio(),WMD.editListing(),WMD.saveListing(),b.fn.select2&&(b(".state-selection").select2({placeholder:"Select a state"}),b(".city-selection").select2({placeholder:"Select a city"}),b(".industry-selection").select2({placeholder:"What industries do you work with?"}),b(".tech-selection").select2({placeholder:"What technologies do you use?"}),b(".services-selection").select2({placeholder:"What services do you provide?"}))},uploadLogo:function(){b(f.getElementById("upload-image")).click(function(a){a.preventDefault(),WMD.media(b(a.target))})},uploadPortfolio:function(){b(f.getElementsByClassName("upload-portfolio")).on("click",function(a){a.preventDefault(),WMD.media(b(a.target),"upload")})},deletePortfolio:function(){b(f.getElementsByClassName("wmd-control")).on("click",function(a){a.preventDefault(),b(a.target).parents(".portfolio-item").remove()})},changePortfolio:function(){b(f.getElementsByClassName("change-portfolio")).on("click",function(a){a.preventDefault(),WMD.media(b(a.target),"update")})},media:function(a,e){"undefined"!=typeof d&&d.close(),d=g.media.frames.customHeader=g.media({title:"Upload image to your Directory Listing",library:{type:"image"},button:{text:"Insert Image"},multiple:!1}),d.on("select",function(){var g=d.state().get("selection").first().toJSON();if("upload"===e){c.templateSettings.variable="data";var h=c.template(b(f.getElementById("portfolio-tmpl")).html()),i={url:g.sizes.full.url,thumb:g.sizes.thumbnail.url,id:g.id,alt:g.title,name:"wmd[portfolio]["+g.id+"]"};b(f.getElementsByClassName("portfolio-items")).find(".upload-btn").before(h(i))}else if("update"===e){a.attr("src",g.sizes.thumbnail.url);var j=g.id;a.parent().next().attr({value:g.sizes.full.url,name:"wmd[portfolio]["+j+"]","data-id":j})}}),d.open()},editListing:function(){b(f.getElementsByClassName("add-new-tax")).click(function(a){a.preventDefault();var c=b(this),d=b(f.getElementById("wmd-listing-nonce")).val();e=c.prev();var g={term:e.val(),tax:e.attr("data-type")};"add-city"===c.attr("id")&&(g.isCity=!0),c.parent().find(".loading").slideDown(),WMD.ajax("wmd_save_listing_tax",d,g)})},saveListing:function(){b(f.getElementById("wmd-listings")).submit(function(a){a.preventDefault();var c=b(this),d=b(f.getElementById("wmd-listing-nonce")).val(),e=this.elements,g={industry:{},tech:{},type:{},portfolio:{}};if(""!==b(f.getElementById("title")).val())return WMD.postNotifications("error","A title is required!");b(f.getElementById("saving-listing")).fadeIn(),tinyMCE.triggerSave(),h=!0,g.content=tinyMCE.activeEditor.getContent(),g.id=c.find("#id").val();for(var j=0;j<e.length;j++){var k=e[j];if(k.hasAttribute("data-save")){var l=k.name.match(/wmd\[(.*)\]\[[0-9]{1,10}\]/);if(null!==l){var m=k.getAttribute("data-id");g.portfolio[m]=k.value}else"industry"===k.id?g.industry=b("#industry").select2("val"):"techonologies"===k.id?g.tech=b("#techonologies").select2("val"):"services"===k.id?g.type=b("#services").select2("val"):"publish"===k.id?k.checked&&(g.publish="publish",i=!0):g[k.id]=k.value}}WMD.ajax("wmd_save_listing_post",d,g)})},ajax:function(a,b,c){g.ajax.send(a,{success:WMD.ajaxSuccess,error:WMD.ajaxError,data:{nonce:b,data:c}})},ajaxSuccess:function(a){if(b(f.getElementById("wmd-listings")).find(".loading").fadeOut(),h)WMD.postNotifications("success",a);else{var c=e.next().attr("id");"add-city"===c?WMD.ajaxCitySuccess(a):WMD.ajaxTaxSuccess(a)}},ajaxTaxSuccess:function(a){var b='<option value="'+a.term_id+'" selected="selected">'+a.name+"*</option>",c=e.prev().prev(),d=c.select2("val"),f=a.name+" has been created and is being reviewed*. Your option will display on your listing soon.";e.val("").prev().prev().append(b),d.push(a.term_id),c.select2("val",d),WMD.listingTaxNotification("success",f)},ajaxCitySuccess:function(a){var b='<option value="'+a.term_id+'" selected="selected">'+a.name+"</option>";e.val("").prev().prev().append(b),e.prev().prev().select2("val",a.term_id)},postNotifications:function(a,c){var d='<div class="wmd-notification wmd-'+a+'">'+c,e=b(f.getElementById("wmd-notifications"));b(f.getElementById("saving-listing")).fadeOut(),i&&(d+=' <a href="/membership-account/view-my-listing/">View Your Listing.</a></div>'),e.empty().html(d),b(f.getElementsByClassName("wmd-notification")).fadeIn()},ajaxError:function(a){h?WMD.postNotifications("error",a):WMD.listingTaxNotification("error",a)},listingTaxNotification:function(a,c){var d='<div class="wmd-notification wmd-'+a+'">'+c+"</div>";b(f.getElementsByClassName("wmd-notification")).fadeOut().remove(),e.next().after(d).next().fadeIn()},isInt:function(a){return!isNaN(a)&&function(a){return(0|a)===a}(parseFloat(a))},load:function(){b.flexslider&&b(".flexslider").flexslider({controlNav:!1})}},b(a).load(WMD.load),b(f).ready(WMD.init)}(this,jQuery,_);